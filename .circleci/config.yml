version: 2.1

##############################################################################
# Reusables
##############################################################################
build_binary_params: &build_binary_params
  parameters:
    docker_image:
      type: string
      default: "ubuntu-2004:202104-01"
    cuda_version:
      type: string
      default: ""
    cudnn_version:
      type: string
      default: "8"
    python_version:
      type: string
      default: ""
    torch_version:
      type: string
      default: ""
  environment:
    DOCKER_IMAGE: << parameters.docker_image >>
    CUDA_VERSION: << parameters.cuda_version >>
    CUDNN_VERSION: << parameters.cudnn_version >>
    PYTHON_VERSION: << parameters.python_version >>
    TORCH_VERSION: << parameters.torch_version >>

commands:
  setup_env: &setup_env
    steps:
      - run:
          name: Install dependencies
          command: |
            apt-get update -y
            DEBIAN_FRONTEND=noninteractive apt-get install -y git-all ninja-build
            # pip3 install --progress-bar off torch==${TORCH_VERSION}+cu$(echo $CUDA_VERSION | sed -E 's/([0-9]+)\.([0-9]+).*/\1\2/')

##############################################################################
# Job specs
##############################################################################
jobs:
  linux_build_wheel:
    <<: *build_binary_params
    docker:
      # - image: nvidia/cuda:<< parameters.cuda_version >>-cudnn<< parameters.cudnn_version >>-devel-ubuntu20.04
      - image: pytorch/pytorch:<< parameters.torch_version >>-cuda<< parameters.cuda_version >>-cudnn<< parameters.cudnn_version >>-devel
    resource_class: large
    steps:
      - setup_env
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Build PyPose wheel
          no_output_timeout: 5m
          command: MAX_JOBS=1 python3 setup.py bdist_wheel

##############################################################################
# Workflows
##############################################################################
workflows:
  version: 2
  build:
    jobs:
      - linux_build_wheel:
          cuda_version: "11.3"
          torch_version: "1.10.0"
